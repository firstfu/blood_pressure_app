# 血壓管家 App 技術架構文件

## 文件資訊

- **文件名稱**：血壓管家 App 技術架構文件
- **版本**：1.2
- **最後更新日期**：2024 年 5 月 28 日

## 目錄

1. [技術概述](#技術概述)
2. [系統架構](#系統架構)
3. [前端架構](#前端架構)
4. [數據架構](#數據架構)
5. [多國語系架構](#多國語系架構)
6. [主題系統架構](#主題系統架構)
7. [安全架構](#安全架構)
8. [開發流程](#開發流程)
9. [測試策略](#測試策略)
10. [性能優化](#性能優化)

## 技術概述

「血壓管家」採用現代化的跨平台技術架構，確保在 iOS 和 Android 平台上提供一致且高質量的用戶體驗。本文檔詳細描述了應用的技術選型、架構設計和實現方案。

### 技術選型理由

1. **Flutter 框架**：

   - 跨平台開發效率高，可維護單一代碼庫
   - 接近原生的性能表現
   - 豐富的 UI 組件和動畫支持
   - 強大的開發者社區和生態系統

2. **MVVM 架構模式**：

   - 清晰的關注點分離
   - 更好的代碼組織和可測試性
   - 適合複雜的用戶界面和交互

3. **本地數據存儲**：
   - 支持離線使用場景
   - 減少網絡請求，提高應用響應速度
   - 保護用戶隱私，敏感數據本地存儲

## 系統架構

### 整體架構

「血壓管家」採用分層架構，主要包括以下幾層：

1. **表現層 (Presentation Layer)**：

   - 使用 Flutter 的 Widget 系統構建用戶界面
   - 實現用戶交互和數據展示

2. **業務邏輯層 (Business Logic Layer)**：

   - 處理應用的核心業務邏輯
   - 管理應用狀態和數據流

3. **數據層 (Data Layer)**：
   - 負責數據的獲取、存儲和處理
   - 提供數據訪問接口

### 模塊劃分

應用按功能模塊劃分為以下幾個主要部分：

1. **用戶管理模塊**：處理用戶資料和設置
2. **血壓記錄模塊**：管理血壓數據的輸入和存儲
3. **數據分析模塊**：處理數據統計和趨勢分析
4. **提醒通知模塊**：管理測量提醒和通知
5. **健康建議模塊**：提供基於數據的健康建議
6. **國際化模塊**：處理多語言支援
7. **主題模塊**：管理深色/淺色模式和主題設定

## 前端架構

### MVVM 架構實現

「血壓管家」採用 MVVM (Model-View-ViewModel) 架構模式：

1. **Model**：

   - 定義數據結構和業務邏輯
   - 主要包括 `BloodPressureRecord` 等數據模型

2. **View**：

   - Flutter Widget 構建的用戶界面
   - 負責展示數據和接收用戶輸入
   - 包括 `HomePage`, `RecordPage`, `StatsPage` 等頁面

3. **ViewModel**：
   - 連接 Model 和 View
   - 處理用戶交互邏輯
   - 管理 UI 狀態和數據轉換

### 目錄結構

```
lib/
├── constants/       # 應用常量定義
├── controllers/     # 控制器和視圖模型
├── l10n/            # 多語言資源和本地化邏輯
├── models/          # 數據模型
├── services/        # 服務層
├── themes/          # 主題和樣式
│   ├── light/       # 淺色主題定義
│   ├── dark/        # 深色主題定義
│   └── theme_provider.dart # 主題管理邏輯
├── utils/           # 工具類
├── views/           # 頁面視圖和相關組件
│   ├── home/        # 首頁視圖及其組件
│   ├── record/      # 記錄頁視圖及其組件
│   ├── analysis/    # 分析頁視圖及其組件
│   ├── settings/    # 設定頁面及其組件
│   │   ├── language_settings/ # 語言設定
│   │   └── theme_settings/    # 主題設定
│   └── onboarding/  # 引導頁面
├── widgets/         # 通用可重用組件
└── main.dart        # 應用入口
```

### UI 組件化

應用採用組件化設計，將 UI 拆分為可重用的小組件，並根據功能和使用範圍進行組織：

1. **頁面級組件**：與特定頁面相關的組件放在該頁面目錄下的 `widgets` 子目錄中
2. **功能組件**：特定功能的組件，如 `TrendChart`, `HealthTipCard` 等
3. **通用組件**：整個應用中共用的基礎 UI 元素，放在 `widgets` 目錄下

## 數據架構

### 數據模型

核心數據模型為 `BloodPressureRecord`，包含以下主要屬性：

- 收縮壓 (systolic)
- 舒張壓 (diastolic)
- 心率 (pulse)
- 測量時間 (measureTime)
- 測量姿勢 (position)
- 測量部位 (arm)
- 備註 (note)
- 服藥狀態 (isMedicated)

### 數據存儲

目前版本使用本地存儲方案：

1. **SQLite 數據庫**：存儲用戶記錄的血壓數據
2. **SharedPreferences**：存儲應用配置，如語言選擇、主題設定等
3. **可選的雲端同步功能**：未來計劃實現

### 數據流

應用中的數據流遵循單向數據流原則：

1. 用戶操作觸發事件
2. 事件傳遞給 ViewModel 處理
3. ViewModel 更新 Model 或獲取數據
4. 數據變化通知 View 更新

## 多國語系架構

### 本地化策略

應用採用 Flutter 內建的本地化機制，並進行了自定義擴展：

1. **支援的語言**：

   - 繁體中文 (zh_TW)
   - 簡體中文 (zh_CN)
   - 英文 (en_US)

2. **文本資源管理**：

   - 使用 Map<String, String> 存儲語系鍵值對
   - 將語系文件放在 `lib/l10n` 目錄下
   - 使用中文作為 key，對應不同語系的翻譯

3. **動態切換**：

   - 使用 Provider 模式管理當前語言設定
   - 提供便捷的 BuildContext 擴展方法 `tr()` 獲取翻譯

4. **自動化工具**：
   - 使用自動化腳本檢測未翻譯或缺失的文本

### 語言選擇邏輯

1. **首次啟動**：自動使用系統語言（如果支援）
2. **手動選擇**：用戶可在設定中手動切換語言
3. **持久化**：使用 SharedPreferences 保存用戶語言偏好

## 主題系統架構

### 主題管理

應用實現了完整的淺色/深色主題系統：

1. **主題定義**：

   - 淺色主題：使用藍色 (#1976D2) 作為主色調
   - 深色主題：使用較亮的藍色 (#90CAF9) 作為主色調，暗灰色 (#121212) 作為背景
   - 各組件的顏色、字體、圓角等樣式統一管理

2. **主題切換**：

   - 系統模式：跟隨系統深色模式設定自動切換
   - 淺色模式：強制使用淺色主題
   - 深色模式：強制使用深色主題

3. **持久化**：

   - 使用 SharedPreferences 保存用戶主題偏好
   - 應用啟動時自動套用上次設定

4. **響應式變化**：
   - 使用 Provider 管理主題狀態
   - UI 元件自動響應主題變化

### 設計考量

1. **可訪問性**：

   - 確保深色模式下文字與背景對比度達到 WCAG AA 標準
   - 增加關鍵元素的視覺差異性

2. **一致性**：

   - 確保所有頁面和元件在兩種模式下均有一致的視覺體驗
   - 保持品牌識別的一致性

3. **性能優化**：
   - 優化主題切換時的重繪過程
   - 避免不必要的重建

## 安全架構

### 數據安全

1. **本地數據加密**：敏感健康數據使用加密存儲
2. **最小權限原則**：僅請求必要的系統權限
3. **安全輸入處理**：防止輸入注入和溢出

### 隱私保護

1. **數據匿名化**：統計和分析數據去除個人標識
2. **透明的隱私政策**：清晰說明數據使用方式
3. **用戶控制**：允許用戶控制數據共享範圍

## 開發流程

### 開發環境

- **IDE**：Android Studio 或 VS Code
- **版本控制**：Git
- **CI/CD**：GitHub Actions

### 開發規範

1. **代碼風格**：遵循 Dart 官方風格指南
2. **命名規範**：
   - 類名：駝峰式 (PascalCase)
   - 變量和方法：小駝峰式 (camelCase)
   - 常量：下劃線分隔大寫 (UPPER_SNAKE_CASE)
3. **註釋規範**：
   - 文件頂部添加文件描述
   - 複雜邏輯添加詳細註釋
   - 公共 API 添加文檔註釋

## 測試策略

### 測試類型

1. **單元測試**：測試獨立功能單元
2. **Widget 測試**：測試 UI 組件
3. **集成測試**：測試多個組件的交互
4. **用戶體驗測試**：測試實際使用場景
5. **多語言測試**：驗證不同語言環境下的顯示效果
6. **主題切換測試**：驗證深淺模式切換的正確性

### 測試工具

- **單元測試**：Flutter test
- **Widget 測試**：Flutter test
- **集成測試**：Flutter integration_test
- **性能測試**：Flutter DevTools

## 性能優化

### UI 性能

1. **減少重建**：合理使用 `const` 構造器和 `shouldRebuild`
2. **懶加載**：延遲加載不立即可見的內容
3. **圖片優化**：使用適當大小和格式的圖片

### 內存優化

1. **資源釋放**：及時釋放不再使用的資源
2. **緩存管理**：限制緩存大小，避免內存泄漏
3. **狀態管理**：避免冗餘狀態和不必要的數據複製

### 電池優化

1. **減少網絡請求**：批量處理和緩存網絡請求
2. **優化後台處理**：減少後台任務頻率和耗時
3. **高效算法**：使用高效的數據處理算法
